<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../vaadin-dialog/vaadin-dialog.html">
<link rel="import" href="../dz-dazzle/dz-login.html">

<dom-module id="login-dialog-overlay-styles" theme-for="vaadin-dialog-overlay">
	<template>
	  <style>
		:host([theme~="login"]) [part="content"] {
			padding:0px;
		}
		[part="overlay"]{
			width:480px;
		}
		html {
			--lumo-space-l :0px;

		}
	

	  </style>
	</template>
  </dom-module>
  

<dom-module id="dz-dazzle">

	<template>

		<style>
			  :host [part="content"] {
				padding:0px;
			}
			:host #dz-logo {
				position: fixed;
				right: 0;
				bottom: 0;
				width: 100px;
				height: 30px;
				background-image: url(http://dazzle.website/image/lgo.png);
				background-size: 100% auto;
				background-repeat: no-repeat;
				cursor: pointer;
				z-index: 99999;
			}
			[hide]{
				display:none;
			}
		</style>
		<vaadin-dialog aria-label="simple" id="login"  theme="login"></vaadin-dialog>
		<div id="dz-logo" on-click="login"></div>
	</template>
</dom-module>

<script>

(function() {



	Polymer({
		is: 'dz-dazzle',
		properties: {
			
		},

		created:function() {
			// super.ready();
			// store.clearAll();
			// let user = store.get('user') || null;
			// let that = this;
			// let editMode = store.get('editMode') || 'normal';
			// let thisPage = decodeURIComponent(window.location.pathname).substring(window.location.pathname.indexOf('/') + 1) || 'index.html';
			let that = this;
			// let url = location.href;
			// var vars = {};
			// var parts = url.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
			// 	vars[key] = value;
			// });
			// console.log('URL',url,Polymer.dzLicense);
	
			if (Polymer.dzLicense['token'] !==""){
				// this.token= vars['token'];
				// console.log('This',this.token,Polymer.dataManager);
				this._login();
				// Polymer.dataManager.getToken(this.token).then(res=>{
					
				// });

			}

			// const myParam = urlParams.get('myParam');

			customElements.whenDefined('vaadin-dialog').then(function() {
				const shadow = that.shadowRoot;
				const dialog = shadow.querySelector('vaadin-dialog#login');
				dialog.renderer = function(root, dialog) {
					root.innerHTML = '<dz-login></dz-login>';
				};
			});
		},
		_login: function () {
			console.log('Login');
			let shadow = this.shadowRoot;
			let that = this;
			let loginUrl = "https://d8fz9pfue5.execute-api.ap-northeast-1.amazonaws.com/prod/newMiscDazzleFunction";
			let params = {
				"action": "loginByToken", "token": Polymer.dzLicense['token']
			};
			Polymer.postData(loginUrl, params).then(res => {
				if (res.code > 0) {
					let uid = res.resolve['uid'];
					let user = res.resolve;
					user['thisPage'] = this.thisPage;
					store.set('user', res.resolve);
					store.set('editMode', 'admin');
					store.set('thisPage', this.thisPage);
					let token = that.generatePassword();
					console.log('Res',res.resolve);
					location.reload();
				}
				else {
					alert('登入錯誤');
				}
			});
		},
		ready:function(){
			let that = this;
			const logo = this.shadowRoot.querySelector('#dz-logo');
			console.log('Logo',logo,Polymer.userType);
			if (Polymer.userType==="professional") {
				logo.setAttribute('hide','');

				document.addEventListener('keypress',e=>{
					console.log('e',e);
					if (e.ctrlKey){
					  if (e.shiftKey){

						switch(e.code){

							case 'KeyL':
							console.log('Logo');
							that.login();
							break;

							}
						}
					}
				});
			}

		},
		login:function(){
			const shadow = this.shadowRoot;

			const dialog = shadow.querySelector('vaadin-dialog#login');
			dialog.opened = true;		
		}
	});

})();

</script>
